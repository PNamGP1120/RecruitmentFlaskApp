{% extends 'layout/base.html' %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="chat-container" id="chat-container">
    {% for message in conversation.messages %}
        <div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
            <strong>{{ message.sender.username }}</strong>
            <p>{{ message.content }}</p>
            <div class="message-info">{{ message.timestamp.strftime('%I:%M %p') }}</div>
        </div>
    {% endfor %}
</div>

<div class="input-area">
    <input type="text" id="message-input" placeholder="Type a message...">
    <button id="send-button">Send</button>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Connect to the Socket.IO server
        const socket = io();
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        const conversationId = "{{ conversation.id }}";
        const currentUserId = "{{ current_user.id }}";

        // Function to scroll to the bottom of the chat
        const scrollToBottom = () => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // 1. Join the specific conversation room once connected
        socket.on('connect', () => {
            console.log('Connected to server!');
            socket.emit('join_room', { room: conversationId });
        });

        // 2. Listen for incoming messages
        socket.on('receive_message', (data) => {
            const messageDiv = document.createElement('div');
            // Determine if the message was sent by the current user or received from another
            const messageClass = parseInt(data.sender_id) === parseInt(currentUserId) ? 'sent' : 'received';
            messageDiv.classList.add('message', messageClass);

            messageDiv.innerHTML = `
                <strong>${data.username}</strong>
                <p>${data.content}</p>
                <div class="message-info">${data.timestamp}</div>
            `;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        });

        // 3. Send a message on button click
        const sendMessage = () => {
            const message = messageInput.value.trim();
            if (message) {
                socket.emit('send_message', {
                    room: conversationId,
                    message: message
                });
                messageInput.value = ''; // Clear input field
            }
        };

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // Scroll to the bottom on initial page load
        scrollToBottom();
    });
</script>

{% endblock %}